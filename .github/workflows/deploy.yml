name: ðŸš€ Salesforce Deployment

on:
  workflow_call:
    inputs:
      BRANCH_NAME:
        required: true
        type: string      
      TEST_LEVEL:
        description: Deployment Test Level
        required: true
        type: string
      SF_USERNAME:
        description: Salesforce username
        required: true
        type: string
      SGD_PACKAGE_DIR:
        description: SFDX git delta generated package directory
        required: false
        default: package
        type: string
      SF_LOGIN_URL:
        description: Salesforce Login URL
        required: false
        default: https://login.salesforce.com
        type: string
    secrets:
      SF_SERVER_KEY:
        description: Salesforce Private key to sign JWT
        required: true
      SF_CONSUMER_KEY:
        description: Salesforce Consumer Key
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: âš™ï¸ Checkout specified branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.BRANCH_NAME }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24" # Use a recent stable Node.js version

      - name: ðŸ’¾ Install Salesforce CLI and Plugins
        run: |
          npm install -g @salesforce/cli
          # Install the sfdx-git-delta plugin
          echo "y" | sf plugins install sfdx-git-delta


      - name: ðŸ” Geneate Delta Package
        id: delta
        run: |
          # Create the output directory before running the delta command
          mkdir "${{ inputs.SGD_PACKAGE_DIR }}"

          sf sgd source delta --from HEAD --to HEAD~1 --output-dir "${{ inputs.SGD_PACKAGE_DIR }}"

      - name: ðŸ”’ Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.SF_SERVER_KEY }}" > server.key
          sf org login jwt --client-id "${{ secrets.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ inputs.SF_USERNAME }}" \
            --instance-url "${{ inputs.SF_LOGIN_URL }}" \
            --set-default-dev-hub \
            --alias deployment-target

      - name: âœ¨ Deploy Delta Metadata
        run: |
          # Use the 'package' directory generated by sfdx-git-delta
          sf project deploy start \
            -x "${{ github.event.inputs.SGD_PACKAGE_DIR }}/package/package.xml" \
            --post-destructive-changes "${{ inputs.SGD_PACKAGE_DIR }}/destructiveChanges/destructiveChanges.xml" \
            --target-org deployment-target \
            --test-level ${{ github.event.inputs.TEST_LEVEL }} \
            --wait 30
