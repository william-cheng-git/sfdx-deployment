name: üöÄ Salesforce Deployment

on:
  workflow_call:
    inputs:
      BRANCH_NAME:
        description: The name of the branch to be deployed
        required: true
        type: string
      BASE_BRANCH_NAME:
        required: false
        type: string
      TEST_LEVEL:
        description: Deployment Test Level, expected values NoTestRun | RunLocalTests | RunAllTestsInOrg | RunSpecifiedTests
        required: true
        type: string
      ENVIRONMENT:
        description: Target deployment environment, the name of your github environment
        required: true
        type: string
      SF_USERNAME:
        description: Salesforce username
        required: true
        type: string
      DEPLOYMENT_SCOPE:
        description: Deployment scope, expected values FULL | DELTA | ROLLBACK
        required: false
        type: string
      DEPLOYMENT_MODE:
        description: Deployment mode, expected values DEPLOY | VALIDATE | QUICK
        required: false
        type: string
      JOB_ID:
        description: Deployment Job Id, required if using quick deploy
        required: false
        type: string
      SGD_PACKAGE_DIR:
        description: SFDX git delta generated package directory
        required: false
        default: package
        type: string
      SF_LOGIN_URL:
        description: Salesforce Login URL
        required: false
        default: https://login.salesforce.com
        type: string
    secrets:
      SF_SERVER_KEY:
        description: Salesforce Private key to sign JWT
        required: true
      SF_CONSUMER_KEY:
        description: Salesforce Consumer Key
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{inputs.ENVIRONMENT}}
    
    steps:
      - name: Input validation
        run: |
          if [[ "${{ inputs.DEPLOYMENT_SCOPE }}" == "DELTA" && "${{ inputs.BASE_BRANCH_NAME }}" == "" ]]; then
            echo "BASE_BRANCH_NAME is required when DEPLOYMENT_SCOPE = DELTA"
            exit 1
          fi

          if [[ "${{ inputs.DEPLOYMENT_MODE }}" == "QUICK" && "${{ inputs.JOB_ID }}" == "" ]]; then
            echo "JOB_ID is required when DEPLOYMENT_MODE = QUICK"
            exit 1
          fi
 
      - name: ‚öôÔ∏è Checkout base branch
        if: ${{ (inputs.DEPLOYMENT_SCOPE == 'DELTA' || inputs.DEPLOYMENT_SCOPE == 'ROLLBACK') && inputs.DEPLOYMENT_MODE != 'QUICK' }}
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.BASE_BRANCH_NAME }}

      - name: ‚öôÔ∏è Get base branch SHA
        if: ${{ (inputs.DEPLOYMENT_SCOPE == 'DELTA' || inputs.DEPLOYMENT_SCOPE == 'ROLLBACK') && inputs.DEPLOYMENT_MODE != 'QUICK' }}
        id: baseBranch
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
    
      - name: ‚öôÔ∏è Checkout specified branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.BRANCH_NAME }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24" # Use a recent stable Node.js version

      - name: üíæ Install Salesforce CLI and Plugins
        run: |
          npm install -g @salesforce/cli
          # Install the sfdx-git-delta plugin
          echo "y" | sf plugins install sfdx-git-delta

      - name: üîç Geneate Delta Package
        if: inputs.DEPLOYMENT_SCOPE == 'DELTA'
        run: |
          # Create the output directory before running the SGD command
          mkdir "${{ inputs.SGD_PACKAGE_DIR }}"

          if [ "${{ vars.SGD_IGNORE_FILE }}" != "" ]; then
            SGD_IGNORE_ARG="--ignore-file ${{ vars.SGD_IGNORE_FILE }}"
          fi

          sf sgd source delta --from ${{ steps.baseBranch.outputs.sha }} --to ${{ inputs.BRANCH_NAME }} $SGD_IGNORE_ARG --output-dir "${{ inputs.SGD_PACKAGE_DIR }}"

      - name: üîç Geneate Rollback Package
        if: inputs.DEPLOYMENT_SCOPE == 'ROLLBACK'
        run: |
          # Create the output directory before running the SGD command
          mkdir "${{ inputs.SGD_PACKAGE_DIR }}"

          if [ "${{ vars.SGD_IGNORE_FILE }}" != "" ]; then
            SGD_IGNORE_ARG="--ignore-file ${{ vars.SGD_IGNORE_FILE }}"
          fi

          sf sgd source delta --from ${{ inputs.BRANCH_NAME }} --to ${{ steps.baseBranch.outputs.sha }} $SGD_IGNORE_ARG --output-dir "${{ inputs.SGD_PACKAGE_DIR }}"

      # - name: üìã Print Formatted Deployment List
      #   if: inputs.DEPLOYMENT_SCOPE == 'DELTA'
      #   run: |
      #     echo "--- START METADATA TO BE DEPLOYED ---"
          
      #     # Use grep to find lines containing members and name tags.
      #     # Then, use awk to process them in sequence and format the output.
      #     cat ${{ inputs.SGD_PACKAGE_DIR }}/package/package.xml | \
      #       grep -E 'members|name' | \
      #       awk '
      #         /<members>/ {
      #           # 1. Extract and store the Member Name (remove tags)
      #           MEMBER = $0;
      #           gsub(/<(\/?members)>/, "", MEMBER);
      #         }
      #         /<name>/ {
      #           # 2. Extract and store the Metadata Type Name (remove tags)
      #           TYPE = $0;
      #           gsub(/<(\/?name)>/, "", TYPE);
                
      #           # 3. Print the stored pair in the desired format
      #           printf "%s : %s\n", TYPE, MEMBER;
      #         }'
      #     echo "--- END METADATA TO BE DEPLOYED ---"

      - name: üîç Geneate full Package
        if: inputs.DEPLOYMENT_SCOPE == 'FULL'
        run: |
          # Create the output directory before running the SGD command
          mkdir "${{ inputs.SGD_PACKAGE_DIR }}"

          if [ "${{ vars.SGD_IGNORE_FILE }}" != "" ]; then
            SGD_IGNORE_ARG="--ignore-file ${{ vars.SGD_IGNORE_FILE }}"
          fi

          # 4b825dc642cb6eb9a060e54bf8d69288fbee4904 is Empty Tree SHA
          sf sgd source delta --from 4b825dc642cb6eb9a060e54bf8d69288fbee4904 --to ${{ inputs.BRANCH_NAME }} $SGD_IGNORE_ARG --output-dir "${{ inputs.SGD_PACKAGE_DIR }}"

      - name: üîí Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.SF_SERVER_KEY }}" > server.key
          sf org login jwt --client-id "${{ secrets.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ inputs.SF_USERNAME }}" \
            --instance-url "${{ inputs.SF_LOGIN_URL }}" \
            --set-default-dev-hub \
            --alias deployment-target

      - name: ‚ú® Deploy Metadata
        id: deployMetadata
        run: |
          export Environment=${{inputs.ENVIRONMENT}}
          eval $(jq -r 'keys[] as $key | "export \($key)=\(.[$key])"' "config/env/${{inputs.ENVIRONMENT}}.json")

          if [ "${{ inputs.DEPLOYMENT_MODE }}" == "DEPLOY" ]; then
            DEPLOYMENT_RESULT=$(sf project deploy start \
              --manifest "${{ inputs.SGD_PACKAGE_DIR }}/package/package.xml" \
              --post-destructive-changes "${{ inputs.SGD_PACKAGE_DIR }}/destructiveChanges/destructiveChanges.xml" \
              --target-org deployment-target \
              --test-level ${{ github.event.inputs.TEST_LEVEL }} \
              --async \
              --json)
          elif [ "${{ inputs.DEPLOYMENT_MODE }}" == "VALIDATE" ]; then
            DEPLOYMENT_RESULT=$(sf project deploy validate \
              --manifest "${{ inputs.SGD_PACKAGE_DIR }}/package/package.xml" \
              --target-org deployment-target \
              --async \
              --json)
          elif [ "${{ inputs.DEPLOYMENT_MODE }}" == "QUICK" ]; then
            DEPLOYMENT_RESULT=$(sf project deploy quick \
              --job-id ${{ inputs.JOB_ID }} \
              --target-org deployment-target \
              --json)
          fi

          DEPLOY_ID=$(echo $DEPLOYMENT_RESULT | jq -r '.result.id')

          echo "deployId=$DEPLOYID" >> $GITHUB_OUTPUT

          echo "Deployment started with ID: $DEPLOY_ID"

          sf project deploy report \
            --target-org deployment-target \
            --job-id $DEPLOY_ID \
            --wait 1 # This flag handles the polling wait time itself

          # REPORT_RESULT=$(sf project deploy report \
          #   --target-org deployment-target \
          #   --job-id $DEPLOY_ID \
          #   --json \
          #   --wait 30) # This flag handles the polling wait time itself

          # # Extract final status
          # STATUS=$(echo $REPORT_RESULT | jq -r '.result.status')
          # echo "Final Status: $STATUS"

          # # Check final status and fail the job if deployment failed
          # if [ "$STATUS" != "Succeeded" ]; then
          #   echo "Deployment failed. Check the full report above."
          #   exit 1
          # fi

      - name: Cancel running sf deployment if there are any
        if: ${{ cancelled() && steps.deployMetadata.outputs.deployId != '' }}
        run: |
          echo "Cancelling deployment Id = ${{ steps.deployMetadata.outputs.deployId }}"
          sf project deploy cancel --job-id ${{ steps.deployMetadata.outputs.deployId }}
