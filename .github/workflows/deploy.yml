name: ðŸš€ Salesforce Deployment

# 1. Configuration
on:
  workflow_call:
    inputs:
      branch_name:
        required: true
        type: string      
      test_level:
        description: "Deployment Test Level"
        required: true
        type: string
      sf_username:
        description: "Salesforce username"
        required: true
        type: string
      sgd_package_dir:
        description: "SFDX git delta generated package directory"
        required: false
        default: "package"
        type: string
      sf_login_url:
        description: "Salesforce Login URL"
        required: false
        default: "https://login.salesforce.com"
        type: string
    secrets:
      SF_SERVER_KEY:
        description: OAuth Private key

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment: Prod

    # 2. Branch Selection and Conditional Run
    # This prevents the workflow from continuing if the selected branch doesn't exist
    # and ensures the checkout step uses the manually selected branch.
    steps:
      - name: Debug
        run: |
          echo "TEST = ${{ vars.TEST }}"

      - name: âš™ï¸ Checkout specified branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.branch_name }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24" # Use a recent stable Node.js version

      - name: ðŸ’¾ Install Salesforce CLI and Plugins
        run: |
          npm install -g @salesforce/cli
          # Install the sfdx-git-delta plugin
          echo "y" | sf plugins install sfdx-git-delta

      # --- START DELTA CALCULATION ---
      - name: ðŸ” Calculate Delta and Generate Package
        id: delta
        run: |
          # CRITICAL FIX: Create the output directory before running the delta command
          mkdir package

          # The SFDX Git Delta command calculates changes and outputs the paths to use.
          # We compare the last commit (HEAD) with the commit before it (HEAD~1).
          sf sgd source delta --from HEAD --to HEAD~1 --output-dir "${{ inputs.sgd_package_dir }}"

          # Check if the package directory was created (i.e., if there are changes)
          if [ -d "package" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected. Deploying delta."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No deployable changes detected between commits."
          fi

          ls package

      - name: ðŸ›‘ Fail if no changes detected
        if: steps.delta.outputs.has_changes == 'false'
        run: |
          echo "No deployable changes detected between HEAD^ and HEAD. Stopping deployment."
          exit 1
      # --- END DELTA CALCULATION ---
      # 3. Secure Authentication (JWT Bearer Flow)
      - name: ðŸ”’ Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.SF_SERVER_KEY }}" > server.key
          sf org login jwt --client-id "${{ secrets.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ secrets.SF_USERNAME }}" \
            --instance-url "${{ inputs.sf_login_url }}" \
            --set-default-dev-hub \
            --alias deployment-target

      - name: âœ¨ Deploy Delta Metadata
        run: |
          # Use the 'package' directory generated by sfdx-git-delta
          sf project deploy start \
            -x ${{ github.event.inputs.sgd_package_dir }}/package/package.xml \
            --post-destructive-changes ${{ inputs.sgd_package_dir }}/destructiveChanges/destructiveChanges.xml \
            --target-org deployment-target \
            --test-level ${{ github.event.inputs.test_level }} \
            --wait 30
